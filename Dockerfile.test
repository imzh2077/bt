# 基础镜像：Debian 12
FROM debian:12

# 1. 先定义基础路径变量，再用其派生其他变量（解决变量未定义问题）
ENV DEBIAN_FRONTEND=noninteractive \
    SERVICE_USER=searxng \
    SERVICE_HOME=/usr/local/searxng \
    GIT_URL=https://github.com/searxng/searxng.git \
    GIT_BRANCH=master \
    SEARXNG_PORT=8848

# 基于SERVICE_HOME派生其他路径（确保变量引用正确）
ENV SEARXNG_SRC=${SERVICE_HOME}/searxng-src \
    SEARXNG_PYENV=${SERVICE_HOME}/searx-pyenv \
    SEARXNG_SETTINGS_PATH=/etc/searxng/settings.yml \
    SEARXNG_UWSGI_APP=searxng.ini

# 2. 安装依赖并修复权限问题
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3-dev python3-babel python3-venv python-is-python3 \
        uwsgi uwsgi-plugin-python3 \
        git build-essential libxslt-dev zlib1g-dev libffi-dev libssl-dev \
        openssl ca-certificates sudo && \
    # 3. 创建服务用户并严格配置目录权限
    useradd --shell /bin/bash --system \
        --home-dir ${SERVICE_HOME} \
        --comment 'Privacy-respecting metasearch engine' ${SERVICE_USER} && \
    # 手动创建所有需要的目录，并强制设置所有者（解决权限问题）
    mkdir -p ${SERVICE_HOME} ${SEARXNG_SRC} $(dirname ${SEARXNG_SETTINGS_PATH}) && \
    chown -R ${SERVICE_USER}:${SERVICE_USER} ${SERVICE_HOME} /etc/searxng && \
    # 4. 切换到searxng用户克隆仓库（确保路径正确且有权限）
    sudo -u ${SERVICE_USER} git clone ${GIT_URL} ${SEARXNG_SRC} -b ${GIT_BRANCH} && \
    # 5. 构建Python虚拟环境
    sudo -u ${SERVICE_USER} python -m venv ${SEARXNG_PYENV} && \
    sudo -u ${SERVICE_USER} bash -c " \
        source ${SEARXNG_PYENV}/bin/activate && \
        pip install -U pip setuptools wheel pyyaml && \
        cd ${SEARXNG_SRC} && \
        pip install --use-pep517 --no-build-isolation -e ." && \
    # 6. 生成配置文件并替换密钥
    sudo -u ${SERVICE_USER} cp ${SEARXNG_SRC}/utils/templates/settings.yml ${SEARXNG_SETTINGS_PATH} && \
    sed -i "s/ultrasecretkey/$(openssl rand -hex 16)/g" ${SEARXNG_SETTINGS_PATH} && \
    # 7. 配置uWSGI
    sudo -u ${SERVICE_USER} cp ${SEARXNG_SRC}/utils/templates/uwsgi.ini /etc/uwsgi/apps-available/${SEARXNG_UWSGI_APP} && \
    sed -i "s|socket = .*|http = 0.0.0.0:${SEARXNG_PORT}|g" /etc/uwsgi/apps-available/${SEARXNG_UWSGI_APP} && \
    sed -i "s|uid = .*|uid = ${SERVICE_USER}|g" /etc/uwsgi/apps-available/${SEARXNG_UWSGI_APP} && \
    sed -i "s|chdir = .*|chdir = ${SEARXNG_SRC}|g" /etc/uwsgi/apps-available/${SEARXNG_UWSGI_APP} && \
    sed -i "s|module = .*|module = searx.webapp:app|g" /etc/uwsgi/apps-available/${SEARXNG_UWSGI_APP} && \
    # 8. 清理缓存
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

EXPOSE ${SEARXNG_PORT}

CMD ["uwsgi", "--ini", "/etc/uwsgi/apps-available/searxng.ini"]
