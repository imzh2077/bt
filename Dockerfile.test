# 基础镜像：Debian 12
FROM debian:12

# 设置环境变量
ENV SERVICE_USER="searxng" \
    SERVICE_HOME="/usr/local/searxng" \
    SEARXNG_SRC="/usr/local/searxng/searxng-src" \
    SEARXNG_PYENV="/usr/local/searxng/searx-pyenv" \
    SEARXNG_SETTINGS_PATH="/etc/searxng/settings.yml"

# 安装系统依赖包
RUN apt-get update && apt-get install -y \
    python3-dev \
    python3-babel \
    python3-venv \
    python-is-python3 \
    git \
    build-essential \
    libxslt-dev \
    zlib1g-dev \
    libffi-dev \
    libssl-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# 创建searxng用户和目录
RUN useradd --shell /bin/bash --system \
    --home-dir "${SERVICE_HOME}" \
    --comment 'Privacy-respecting metasearch engine' ${SERVICE_USER} \
    && mkdir -p "${SERVICE_HOME}" \
    && chown -R "${SERVICE_USER}:${SERVICE_USER}" "${SERVICE_HOME}"

# 切换到searxng用户进行后续操作
USER ${SERVICE_USER}
WORKDIR ${SERVICE_HOME}

# 克隆SearXNG源码
RUN git clone "https://github.com/searxng/searxng" "${SEARXNG_SRC}"

# 创建Python虚拟环境
RUN python3 -m venv "${SEARXNG_PYENV}"

# 更新pip并安装基础依赖
RUN ${SEARXNG_PYENV}/bin/pip install -U pip setuptools wheel

# 安装SearXNG依赖和包（使用常规安装）
RUN cd "${SEARXNG_SRC}" && ${SEARXNG_PYENV}/bin/pip install .

# 切换回root用户创建配置目录
USER root
RUN mkdir -p /etc/searxng

# 复制配置文件
COPY settings.yml ${SEARXNG_SETTINGS_PATH}
RUN chown -R ${SERVICE_USER}:${SERVICE_USER} /etc/searxng

# 生成安全密钥
RUN sed -i "s/ultrasecretkey/$(openssl rand -hex 32)/g" "${SEARXNG_SETTINGS_PATH}"

# 切换回searxng用户运行
USER ${SERVICE_USER}
WORKDIR ${SEARXNG_SRC}

# 设置环境变量
ENV SEARXNG_SETTINGS_PATH="/etc/searxng/settings.yml"

# 暴露端口
EXPOSE 8080

# 启动命令 - 使用开发服务器
CMD ["../searx-pyenv/bin/python", "searx/webapp.py"]
